<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Account</title>
    <script type="text/javascript" src="bower_components/bignumber.js/bignumber.min.js"></script>
    <script type="text/javascript" src="bower_components/web3/dist/web3.js"></script>
    <script>

        function logToScreen(message)
        {
            document.getElementById('result').textContent = message;
        }

        function refreshAccount()
        {
            var address = document.getElementById('address').value;
            var balanceInWei = web3.eth.getBalance(address).toNumber();
            var balanceInEth = web3.fromWei(balanceInWei, 'ether');
            document.getElementById('balance').textContent = balanceInEth + " ETH";
            var authorized = "<tr><td>Address</td><td>Start Time</td><td>Duration</td><td>Maturity</td></tr>";
            for(var i=0;; i++)
            {
                var result = tradingAccount._addresses(i);
                if(result=="0x") break;
                console.log(result);
                var deets = tradingAccount._authorized(result);
                var duration = deets[0].c[0];
                var startTime = deets[1].c[0];
                console.log(deets);
                console.log(duration);
                console.log(startTime);
                var localTime = new Date((duration + startTime)*10).toLocaleString();
                authorized += "<tr><td>" + result + "</td><td>" + startTime + "</td><td>" + duration + "</td><td>" + localTime + "</td></tr>";
            }
            document.getElementById('authorized').innerHTML = authorized;
        }

        function createAccount()
        {
            logToScreen("Creating a new trading account..");
            tradingAccount = tradingAccountContract.new(
                    {
                        from: web3.eth.accounts[0],
                        data: '60606040525b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055507fb7eea737518395a13554d9e8ad78c0267c7a2ed72bacbd66b1371e0754fca21160405180807f54726164696e67204163636f756e7420496e697469616c697a65642e00000000815260200150602001905060405180910390a15b610875806100996000396000f36060604052361561008a576000357c0100000000000000000000000000000000000000000000000000000000900480632e1a7d4d1461008c5780634f82517c146100b8578063af5f98b4146100fa578063b2bdfa7b1461012d578063c1dbd9b214610166578063caf19e5a1461019b578063d0e30db0146101c7578063fe9fbb80146101ea5761008a565b005b6100a260048080359060200190919050506103c2565b6040518082815260200191505060405180910390f35b6100ce60048080359060200190919050506102cb565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b610110600480803590602001909190505061029e565b604051808381526020018281526020019250505060405180910390f35b61013a6004805050610278565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61018560048080359060200190919080359060200190919050506104b0565b6040518082815260200191505060405180910390f35b6101b16004808035906020019091905050610216565b6040518082815260200191505060405180910390f35b6101d4600480505061030d565b6040518082815260200191505060405180910390f35b61020060048080359060200190919050506107c6565b6040518082815260200191505060405180910390f35b6000811561024a577f7375636365656465640000000000000000000000000000000000000000000000905061027356610272565b7f6661696c656400000000000000000000000000000000000000000000000000009050610273565b5b919050565b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60016000506020528060005260406000206000915090508060000160005054908060010160005054905082565b600260005081815481101561000257906000526020600020900160005b9150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161480610370575061036f336107c6565b5b1561038257600190506103bf566103be565b3373ffffffffffffffffffffffffffffffffffffffff16600034604051809050600060405180830381858888f1935050505050600090506103bf565b5b90565b60003073ffffffffffffffffffffffffffffffffffffffff1631821115610400573073ffffffffffffffffffffffffffffffffffffffff1631915081505b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806104615750610460336107c6565b5b156104a2573373ffffffffffffffffffffffffffffffffffffffff16600083604051809050600060405180830381858888f1935050505050600190506104ab565b600090506104ab565b919050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163273ffffffffffffffffffffffffffffffffffffffff1614151561056e577fb7eea737518395a13554d9e8ad78c0267c7a2ed72bacbd66b1371e0754fca21160405180807f41757468206e6f742073656e74206279206163636f756e74206f776e65722e00815260200150602001905060405180910390a1600091506107bf565b60008314156105da577fb7eea737518395a13554d9e8ad78c0267c7a2ed72bacbd66b1371e0754fca21160405180807f5a65726f206475726174696f6e20696e20617574682063616c6c2e0000000000815260200150602001905060405180910390a1600091506107bf565b600160005060008573ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005090506000816000016000505414156107165760406040519081016040528084815260200142815260200150600160005060008673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000820151816000016000505560208201518160010160005055905050600260005080548060010182818154818355818115116106d2578183600052602060002091820191016106d191906106b3565b808211156106cd57600081815060009055506001016106b3565b5090565b5b5050509190906000526020600020900160005b86909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550506107b6565b82610749826040604051908101604052908160008201600050548152602001600182016000505481526020015050610851565b10156107b55760406040519081016040528084815260200142815260200150600160005060008673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060008201518160000160005055602082015181600101600050559050505b5b600191506107bf565b5092915050565b60006000600160005060008473ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005090506000816000016000505411801561084457506000610841826040604051908101604052908160008201600050548152602001600182016000505481526020015050610851565b10155b915061084b565b50919050565b60006000603c8360200151420304905080836000015103915061086f565b5091905056',
                        gas: 3000000
                    }, function(e, contract){
                        console.log(e, contract);
                        if (typeof contract.address != 'undefined') {
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                            document.getElementById('address').value = contract.address;
                            logToScreen("New trading account created at " + contract.address);
                            refreshAccount();
                            contract.allEvents().watch(function(error, log){
                                if(!error) {
                                    console.log("Received Event: ", log.event);
                                    console.log(log);
                                    console.log("The args were: ");
                                    for (var arg in log.args) {
                                        console.log(arg, "=>", web3.toUtf8(log.args[arg]));
                                    }
                                }
                            });
                        }
                    });

        }

        function fundContract()
        {
            logToScreen("Funding trading account with 1 ETH..");
            var address = document.getElementById('address').value;
            var amount = web3.toWei(1, 'ether');
            web3.eth.sendTransaction({"from": web3.eth.coinbase, "to": address, "value": amount},
                    function(err, result) {
                        console.log(err, result);
                        logToScreen("Funded trading account with 1 ETH. The new balance will be reflected soon.");
                    });
        }


        function loadAccount()
        {
            logToScreen("Loading trading account..");
            var address = document.getElementById('address').value;
            tradingAccount = tradingAccountContract.at(address);
            console.log(tradingAccount);
            logToScreen("Loaded trading account.");
            refreshAccount();
        }

        function authorizeAddress()
        {
            var authorizee = document.getElementById('authorizee').value;
            var result = tradingAccount.authorize.sendTransaction(
                    authorizee,
                    1000000000000,
                    {from: web3.eth.coinbase, value: 0, gas: 2000000},
                    function(err, result){
                        console.log(err, result);
                        logToScreen("Account authorized.");
                    }
            );
        }

        var web3 = require('web3');
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:56000'));
        var abi = [{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"_addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"_authorized","outputs":[{"name":"duration","type":"uint256"},{"name":"startTime","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"_owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"accountAddr","type":"address"},{"name":"duration","type":"uint256"}],"name":"authorize","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"flag","type":"bool"}],"name":"toText","outputs":[{"name":"","type":"bytes32"}],"type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"accountAddr","type":"address"}],"name":"isAuthorized","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"message","type":"bytes32"}],"name":"GenericLogEvent","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"bytes32"},{"indexed":false,"name":"success","type":"bytes32"}],"name":"Authorization","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"bytes32"},{"indexed":false,"name":"success","type":"bytes32"}],"name":"Validation","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"bytes32"},{"indexed":false,"name":"success","type":"bytes32"}],"name":"Withdrawal","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"addr","type":"bytes32"},{"indexed":false,"name":"success","type":"bytes32"}],"name":"Exercise","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"from","type":"bytes32"},{"indexed":false,"name":"to","type":"bytes32"},{"indexed":false,"name":"amount","type":"bytes32"}],"name":"CashFlow","type":"event"}];
        var tradingAccountContract = web3.eth.contract(abi);
        var tradingAccount;

    </script>
</head>
<body>
    <h1>Trading Account</h1>

    <div style="background-color: azure " id="result"></div>

    <h2>Status</h2>

    <input type="text" id="address" size="40" />
    <button onclick="createAccount()">Create</button>
    <button onclick="loadAccount()">Load</button>
    <button onclick="fundContract()">Fund</button>
    <button onclick="refreshAccount()">Refresh</button>
    <p><b>Balance</b></p>
    <p id="balance" />
    <p><b>Authorized Contracts</b></p>
    <table id="authorized"></table>

    <h2>Actions</h2>

    <input type="text" id="authorizee" size="40" />
    <button onclick="authorizeAddress()">Authorize Address</button>
</body>
</html>