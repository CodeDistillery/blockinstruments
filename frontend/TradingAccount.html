<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Account</title>
    <script type="text/javascript" src="bower_components/bignumber.js/bignumber.min.js"></script>
    <script type="text/javascript" src="bower_components/web3/dist/web3.js"></script>
    <script>

        function logToScreen(message)
        {
            document.getElementById('result').textContent = message;
        }

        function refreshAccount()
        {
            var address = document.getElementById('address').value;
            var balanceInWei = web3.eth.getBalance(address).toNumber();
            var balanceInEth = web3.fromWei(balanceInWei, 'ether');
            document.getElementById('balance').textContent = "Balance: " +  balanceInEth + " ETH";
            //var state = web3.eth.getStorageAt(address, 2);
            //console.log(state); // "0x03"
            /*var result = tradingAccount._addresses.call(
                    '0x66e5667e9ff37b7f5e29afc57fc9b645a66e9fd4',
                    function(err, result){
                        console.log(result);
                    }
            );*/
            var result = tradingAccount._addresses.call(
                    '0x66e5667e9ff37b7f5e29afc57fc9b645a66e9fd4');
            //var result = new BigNumber(tradingAccount._owner.call());
            console.log(result);
        }

        function createAccount()
        {
            logToScreen("Creating a new trading account..");
            tradingAccount = tradingAccountContract.new(
                    {
                        from: web3.eth.accounts[0],
                        data: '60606040525b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b6106ac8061003f6000396000f360606040523615610074576000357c0100000000000000000000000000000000000000000000000000000000900480632e1a7d4d146100765780634f82517c146100a2578063af5f98b4146100e4578063b2bdfa7b14610117578063c1dbd9b214610150578063d0e30db01461018557610074565b005b61008c60048080359060200190919050506102f2565b6040518082815260200191505060405180910390f35b6100b860048080359060200190919050506101fb565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6100fa60048080359060200190919050506101ce565b604051808381526020018281526020019250505060405180910390f35b61012460048050506101a8565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61016f60048080359060200190919080359060200190919050506103e0565b6040518082815260200191505060405180910390f35b610192600480505061023d565b6040518082815260200191505060405180910390f35b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60016000506020528060005260406000206000915090508060000160005054908060010160005054905082565b600260005081815481101561000257906000526020600020900160005b9150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60003373ffffffffffffffffffffffffffffffffffffffff16600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614806102a0575061029f336105f5565b5b156102b257600190506102ef566102ee565b3373ffffffffffffffffffffffffffffffffffffffff16600034604051809050600060405180830381858888f1935050505050600090506102ef565b5b90565b60003073ffffffffffffffffffffffffffffffffffffffff1631821115610330573073ffffffffffffffffffffffffffffffffffffffff1631915081505b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806103915750610390336105f5565b5b156103d2573373ffffffffffffffffffffffffffffffffffffffff16600083604051809050600060405180830381858888f1935050505050600190506103db565b600090506103db565b919050565b600060006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163273ffffffffffffffffffffffffffffffffffffffff1614151561044657600092506105ed565b600084141561045857600092506105ed565b600160005060008673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005091506000826000016000505414806104cf5750836104cd836040604051908101604052908160008201600050548152602001600182016000505481526020015050610680565b105b156105e45760406040519081016040528085815260200142815260200150600160005060008773ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000820151816000016000505560208201518160010160005055905050600260005080549050905060018101600260005081815481835581811511610593578183600052602060002091820191016105929190610574565b8082111561058e5760008181506000905550600101610574565b5090565b5b5050505084600260005082815481101561000257906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690830217905550600192506105ed565b600092506105ed565b505092915050565b60006000600160005060008473ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005090506000816000016000505411801561067357506000610670826040604051908101604052908160008201600050548152602001600182016000505481526020015050610680565b10155b915061067a565b50919050565b60006000600083602001514203915062015180820490508084600001510392506106a5565b505091905056',
                        gas: 3000000
                    }, function(e, contract){
                        if (typeof contract.address != 'undefined') {
                            console.log(e, contract);
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                            document.getElementById('address').value = contract.address;
                            logToScreen("New trading account created at " + contract.address);
                            refreshAccount();
                        }
                    });
        }

        function fundContract()
        {
            logToScreen("Funding trading account with 1 ETH..");
            var address = document.getElementById('address').value;
            var amount = web3.toWei(1, 'ether');
            web3.eth.sendTransaction({"from": web3.eth.defaultAccount, "to": address, "value": amount},
                    function(err, result) {
                        console.log(err, result);
                        logToScreen("Funded trading account with 1 ETH. The new balance will be reflected soon.");
                    });
        }


        function loadAccount()
        {
            logToScreen("Loading trading account..");
            var address = document.getElementById('address').value;
            tradingAccount = tradingAccountContract.at(address);
            console.log(tradingAccount);
            logToScreen("Loaded trading account.");
            refreshAccount();
        }

        function authorizeAddress()
        {
            var authorizee = document.getElementById('authorizee').value;
            var result = tradingAccount.authorize.sendTransaction(
                    authorizee,
                    100,
                    {from: web3.eth.defaultAccount, value: 0, gas: 2000000},
                    function(err, result){
                        console.log(err, result);
                        logToScreen("Account authorized.");
                    }
            );
        }

        var web3 = require('web3');
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:56000'));
        var abi = [{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"_addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"_authorized","outputs":[{"name":"numDays","type":"uint256"},{"name":"startTime","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"_owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"accountAddr","type":"address"},{"name":"numDays","type":"uint256"}],"name":"authorize","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"}];
        var tradingAccountContract = web3.eth.contract(abi);
        var tradingAccount;

    </script>
</head>
<body>
    <h1>Trading Account</h1>

    <div style="background-color: azure " id="result"></div>

    <h2>Status</h2>

    <input type="text" id="address" size="40" />
    <button onclick="createAccount()">Create</button>
    <button onclick="loadAccount()">Load</button>
    <button onclick="fundContract()">Fund</button>
    <button onclick="refreshAccount()">Refresh</button>
    <p id="balance">Balance not read yet.</p>

    <h2>Actions</h2>

    <input type="text" id="authorizee" size="40" />
    <button onclick="authorizeAddress()">Authorize Address</button>
</body>
</html>