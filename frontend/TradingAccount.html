<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trading Account</title>
    <script type="text/javascript" src="bower_components/bignumber.js/bignumber.min.js"></script>
    <script type="text/javascript" src="bower_components/web3/dist/web3.js"></script>
    <script>

        function logToScreen(message)
        {
            document.getElementById('result').textContent = message;
        }

        function refreshAccount()
        {
            var address = document.getElementById('address').value;
            var balanceInWei = web3.eth.getBalance(address).toNumber();
            var balanceInEth = web3.fromWei(balanceInWei, 'ether');
            document.getElementById('balance').textContent = balanceInEth + " ETH";
            var authorized = "<tr><td>Address</td><td>Start Time</td><td>Duration</td><td>Maturity</td></tr>";
            for(var i=0;; i++)
            {
                var result = tradingAccount._addresses(i);
                if(result=="0x") break;
                console.log(result);
                var deets = tradingAccount._authorized(result);
                var duration = deets[0].c[0];
                var startTime = deets[1].c[0];
                console.log(deets);
                console.log(duration);
                console.log(startTime);
                var localTime = new Date((duration + startTime)*10).toLocaleString();
                authorized += "<tr><td>" + result + "</td><td>" + startTime + "</td><td>" + duration + "</td><td>" + localTime + "</td></tr>";
            }
            document.getElementById('authorized').innerHTML = authorized;
        }

        function createAccount()
        {
            logToScreen("Creating a new trading account..");
            tradingAccount = tradingAccountContract.new(
                    {
                        from: web3.eth.accounts[0],
                        data: '60606040525b33600060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505b6106c78061003f6000396000f36060604052361561007f576000357c0100000000000000000000000000000000000000000000000000000000900480632e1a7d4d146100815780634f82517c146100ad578063af5f98b4146100ef578063b2bdfa7b14610122578063c1dbd9b21461015b578063d0e30db014610190578063fe9fbb80146101b35761007f565b005b6100976004808035906020019091905050610329565b6040518082815260200191505060405180910390f35b6100c36004808035906020019091905050610232565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6101056004808035906020019091905050610205565b604051808381526020018281526020019250505060405180910390f35b61012f60048050506101df565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61017a6004808035906020019091908035906020019091905050610417565b6040518082815260200191505060405180910390f35b61019d6004805050610274565b6040518082815260200191505060405180910390f35b6101c96004808035906020019091905050610618565b6040518082815260200191505060405180910390f35b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60016000506020528060005260406000206000915090508060000160005054908060010160005054905082565b600260005081815481101561000257906000526020600020900160005b9150909054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60003373ffffffffffffffffffffffffffffffffffffffff16600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614806102d757506102d633610618565b5b156102e9576001905061032656610325565b3373ffffffffffffffffffffffffffffffffffffffff16600034604051809050600060405180830381858888f193505050505060009050610326565b5b90565b60003073ffffffffffffffffffffffffffffffffffffffff1631821115610367573073ffffffffffffffffffffffffffffffffffffffff1631915081505b600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806103c857506103c733610618565b5b15610409573373ffffffffffffffffffffffffffffffffffffffff16600083604051809050600060405180830381858888f193505050505060019050610412565b60009050610412565b919050565b60006000600060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163273ffffffffffffffffffffffffffffffffffffffff1614151561047b5760009150610611565b600083141561048d5760009150610611565b600160005060008573ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005090506000816000016000505414806105045750826105028260406040519081016040529081600082016000505481526020016001820160005054815260200150506106a3565b105b156106085760406040519081016040528084815260200142815260200150600160005060008673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000820151816000016000505560208201518160010160005055905050600260005080548060010182818154818355818115116105c0578183600052602060002091820191016105bf91906105a1565b808211156105bb57600081815060009055506001016105a1565b5090565b5b5050509190906000526020600020900160005b86909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908302179055505060019150610611565b60009150610611565b5092915050565b60006000600160005060008473ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050905060008160000160005054118015610696575060006106938260406040519081016040529081600082016000505481526020016001820160005054815260200150506106a3565b10155b915061069d565b50919050565b60006000603c836020015142030490508083600001510391506106c1565b5091905056',
                        gas: 3000000
                    }, function(e, contract){
                        console.log(e, contract);
                        if (typeof contract.address != 'undefined') {
                            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                            document.getElementById('address').value = contract.address;
                            logToScreen("New trading account created at " + contract.address);
                            refreshAccount();
                        }
                    });
        }

        function fundContract()
        {
            logToScreen("Funding trading account with 1 ETH..");
            var address = document.getElementById('address').value;
            var amount = web3.toWei(1, 'ether');
            web3.eth.sendTransaction({"from": web3.eth.coinbase, "to": address, "value": amount},
                    function(err, result) {
                        console.log(err, result);
                        logToScreen("Funded trading account with 1 ETH. The new balance will be reflected soon.");
                    });
        }


        function loadAccount()
        {
            logToScreen("Loading trading account..");
            var address = document.getElementById('address').value;
            tradingAccount = tradingAccountContract.at(address);
            console.log(tradingAccount);
            logToScreen("Loaded trading account.");
            refreshAccount();
        }

        function authorizeAddress()
        {
            var authorizee = document.getElementById('authorizee').value;
            var result = tradingAccount.authorize.sendTransaction(
                    authorizee,
                    1000000000000,
                    {from: web3.eth.coinbase, value: 0, gas: 2000000},
                    function(err, result){
                        console.log(err, result);
                        logToScreen("Account authorized.");
                    }
            );
        }

        var web3 = require('web3');
        web3.setProvider(new web3.providers.HttpProvider('http://localhost:56000'));
        var abi = [{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdraw","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"_addresses","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"_authorized","outputs":[{"name":"duration","type":"uint256"},{"name":"startTime","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"_owner","outputs":[{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"accountAddr","type":"address"},{"name":"duration","type":"uint256"}],"name":"authorize","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"accountAddr","type":"address"}],"name":"isAuthorized","outputs":[{"name":"","type":"bool"}],"type":"function"},{"inputs":[],"type":"constructor"}];
        var tradingAccountContract = web3.eth.contract(abi);
        var tradingAccount;

    </script>
</head>
<body>
    <h1>Trading Account</h1>

    <div style="background-color: azure " id="result"></div>

    <h2>Status</h2>

    <input type="text" id="address" size="40" />
    <button onclick="createAccount()">Create</button>
    <button onclick="loadAccount()">Load</button>
    <button onclick="fundContract()">Fund</button>
    <button onclick="refreshAccount()">Refresh</button>
    <p><b>Balance</b></p>
    <p id="balance" />
    <p><b>Authorized Contracts</b></p>
    <table id="authorized"></table>

    <h2>Actions</h2>

    <input type="text" id="authorizee" size="40" />
    <button onclick="authorizeAddress()">Authorize Address</button>
</body>
</html>